<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head th:replace="~{fragments/layout :: head}">
    <title>Submit Claim - HICMS</title>
</head>
<body class="d-flex flex-column min-vh-100">

<nav th:replace="~{fragments/layout :: navbar}"></nav>
<div th:replace="~{fragments/layout :: alerts}"></div>

<main class="container my-4 flex-grow-1">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card">
                <div class="card-header">
                    <h4><i class="bi bi-clipboard2-plus"></i> Submit New Claim</h4>
                </div>
                <div class="card-body">
                    <form th:action="@{/claims/submit}" method="post" th:object="${claim}" 
                          enctype="multipart/form-data" id="claimForm">
                        
                        <!-- Agent Section: Select Customer -->
                        <div th:if="${userRole != null && userRole.name() == 'AGENT'}" class="mb-3">
                            <label for="customerId" class="form-label">Select Customer *</label>
                            <select class="form-select" id="customerId" name="customerId" required
                                    onchange="loadCustomerEnrollments(this.value)">
                                <option value="">-- Select Customer --</option>
                                <option th:each="customer : ${customers}" 
                                        th:value="${customer.userId}"
                                        th:text="${customer.fullName + ' (' + customer.email + ')'}">
                                    Customer
                                </option>
                            </select>
                            <div class="form-text">Select the customer for whom you are filing this claim</div>
                        </div>
                        
                        <!-- Agent Section: Customer's Enrollments (loaded dynamically) -->
                        <div th:if="${userRole != null && userRole.name() == 'AGENT'}" class="mb-3" id="customerEnrollmentsDiv" style="display:none;">
                            <label for="customerPolicyId" class="form-label">Select Customer's Policy *</label>
                            <select class="form-select" id="customerPolicyId" name="policyId">
                                <option value="">-- Select Policy --</option>
                            </select>
                            <div class="form-text">Select the policy under which to file this claim</div>
                        </div>
                        
                        <!-- User Section: Their own enrollments -->
                        <div th:if="${userRole == null || userRole.name() == 'USER'}" class="mb-3">
                            <label for="policyId" class="form-label">Select Policy Enrollment *</label>
                            <select class="form-select" id="policyId" th:field="*{policyId}" required>
                                <option value="">-- Select Enrollment --</option>
                                <option th:each="enrollment : ${enrollments}" 
                                        th:value="${enrollment.policyId}"
                                        th:text="${enrollment.policyName + ' - ' + enrollment.policyNumber + ' (Coverage: $' + enrollment.coverageAmount + ')'}">
                                    Policy
                                </option>
                            </select>
                            <div class="form-text">Select the policy under which you want to file this claim</div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="claimAmount" class="form-label">Claim Amount ($) *</label>
                            <input type="number" class="form-control" id="claimAmount" 
                                   th:field="*{claimAmount}" step="0.01" min="0.01" required>
                            <div class="form-text">Enter the amount you are claiming</div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="description" class="form-label">Claim Description *</label>
                            <textarea class="form-control" id="description" th:field="*{description}" 
                                      rows="5" required
                                      placeholder="Please provide detailed information about your claim including:
- Date of incident/treatment
- Nature of the medical service or treatment
- Hospital/clinic name
- Doctor's name
- Any relevant medical conditions"></textarea>
                        </div>
                        
                        <div class="mb-3">
                            <label for="documents" class="form-label">Supporting Documents</label>
                            <input type="file" class="form-control" id="documents" name="documents" 
                                   multiple accept=".pdf,.jpg,.jpeg,.png,.doc,.docx">
                            <div class="form-text">
                                Upload supporting documents (medical reports, bills, prescriptions, etc.)
                                <br>Accepted formats: PDF, JPG, PNG, DOC, DOCX (Max 10MB each)
                            </div>
                        </div>
                        
                        <div class="alert alert-info">
                            <i class="bi bi-info-circle"></i>
                            <strong>Important:</strong>
                            <ul class="mb-0 mt-2">
                                <li>Ensure all information provided is accurate and complete</li>
                                <li>Attach all relevant supporting documents for faster processing</li>
                                <li>Claims are typically processed within 5-7 business days</li>
                                <li>You will be notified via email once your claim is reviewed</li>
                            </ul>
                        </div>
                        
                        <div class="d-flex justify-content-between">
                            <a th:href="@{/claims}" class="btn btn-secondary">
                                <i class="bi bi-arrow-left"></i> Cancel
                            </a>
                            <button type="submit" class="btn btn-primary">
                                <i class="bi bi-send"></i> Submit Claim
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</main>

<footer th:replace="~{fragments/layout :: footer}"></footer>
<div th:replace="~{fragments/layout :: scripts}"></div>

<script th:inline="javascript">
    function loadCustomerEnrollments(customerId) {
        const enrollmentsDiv = document.getElementById('customerEnrollmentsDiv');
        const policySelect = document.getElementById('customerPolicyId');
        
        if (!customerId) {
            enrollmentsDiv.style.display = 'none';
            policySelect.innerHTML = '<option value="">-- Select Policy --</option>';
            return;
        }
        
        // Fetch customer enrollments via AJAX
        fetch('/api/enrollments/user/' + customerId)
            .then(response => response.json())
            .then(enrollments => {
                policySelect.innerHTML = '<option value="">-- Select Policy --</option>';
                enrollments.forEach(enrollment => {
                    const option = document.createElement('option');
                    option.value = enrollment.policyId;
                    option.textContent = enrollment.policyName + ' - ' + enrollment.policyNumber + ' (Coverage: $' + enrollment.coverageAmount + ')';
                    policySelect.appendChild(option);
                });
                enrollmentsDiv.style.display = 'block';
            })
            .catch(error => {
                console.error('Error loading enrollments:', error);
                alert('Failed to load customer enrollments');
            });
    }
</script>
</body>
</html>
